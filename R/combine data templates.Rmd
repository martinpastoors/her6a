---
output:
  word_document: 
    reference_docx: ../my_template.dotx
---


```{r, message=FALSE, warning=FALSE, include=FALSE}

# ==================================================================
# Combine data templates.r
# 
# Read data and convert to RData sets
#
# Martin Pastoors
#
# R version: 3.5
# 
# 01/11/2016 initial coding
# 06/03/2017 adapted for final report
# 06/04/2017 checking number of samples
# 26/09/2017 reading the 2017 data
# 06/10/2017 finalized reading 2017 data
# 19/10/2017 converted to rMarkdown
# 20/10/2017 started reading lat long files - not continued
# 01/11/2017 finished coding at HER6a workshop
# 07/02/2018 adapted code to latest data spreadsheets
# 22/11/2018 version for 2018 survey
# 11/02/2019 excluded haul 10 of Alida for ages
# 30/09/2019 first version for 2019 data
# 19/11/2019 preparing for data workshop
# ==================================================================

require("knitr")
knitr::opts_chunk$set(echo = FALSE,	message = FALSE,	warning = FALSE,	crop = TRUE,	comment = "")
knit_hooks$set(crop = hook_pdfcrop)

# Reset lists
rm(list=ls())

library(sp)            # e.g. point in polygon
library(readxl)        # Hadleys simple package for reading excel
library(lubridate)     # date functions
library(stringr)       # string manipulation
library(pander)        # for tables
library(tidyverse)     # dplyr, tidyr, ggplot etc. 
library(ggridges)      # new instead of ggjoy 
library(reshape2)      # dcast
library(scales)
library(ggrepel)       # fancy text labelling
# library(scatterpie)

# library(gisland)
source("../../gisland/r/geo_inside.R")

# source utils
source("../../mptools/R/my_utils.r")

# get dropbox directory
dropboxdir <- paste(get_dropbox(), "/6a Herring survey planning", sep="")

# get onedrive directory (either automatically or manually)
onedrive <- file.path(Sys.getenv('USERPROFILE'), 'PFA/PFA team site - PRF') 

surveyyear <- 2019

# ================================================================================
# Set working directory and filename
# ================================================================================

# Working directory
# setwd("D:/Dropbox/6a Herring survey planning/2017/DATA/")
#  load the map files
load(paste(dropboxdir,"/GIS/world.europe.df.RData", sep=""))
load(paste(dropboxdir,"/GIS/eez.europe.df.RData", sep=""))
load(paste(dropboxdir,"/GIS/fao27.df.RData", sep=""))

load(paste(dropboxdir,"/GIS/fao.RData", sep=""))
load(paste(dropboxdir,"/GIS/icesrectangles.RData", sep=""))

# ================================================================================
# Read survey areas
# ================================================================================

areas <- 
  read.csv(file=file.path(dropboxdir, surveyyear, "DATA","Survey areas.csv"), 
           header=TRUE, stringsAsFactors = FALSE)

# ================================================================================
# Vessel names
# ================================================================================

vesselnames <- data.frame(
    vessel     = c("KW172"    , "PH2200"  , "FR249"   , "PD165"  , "LK62"   ),
    vesselname = c("Dirk Dirk", "Wiron5+6", "Grateful", "Pathway", "Research"), 
    stringsAsFactors = FALSE)

# ================================================================================
# Building up file list
# ================================================================================

file.list <- 
  list.files(path = file.path(dropboxdir, surveyyear, "DATA"),
             pattern="Data recording",recursive=F, full.names=TRUE, ignore.case=TRUE) 

  # remove tilde files
file.list <- grep("~", file.list, invert=TRUE, value = TRUE)

# ================================================================================
# read haul sheets
# ================================================================================

# i <- 1

haul <- NULL
j    <- 0

for (i in 1:length(file.list)){   
  if ("Haul" %in% excel_sheets(file.list[i])) {
    j <- j+1
    tmp<- 
      read_excel(file.list[i], sheet="Haul", col_names=TRUE, 
                 col_types ="text", skip=0, range=cell_cols("A:AQ") ) %>% 
      lowcase() %>% 
      mutate(file     = file.list[i],
             sheet    = "Haul") %>% 
      filter(!is.na(haul), !is.na(date)) %>% 
      
      # remove column names starting with x
      select(one_of(colnames(.)[!grepl("x",tolower(colnames(.)))]) ) %>% 
      data.frame() 

    print(file.list[i])
    # print(names(tmp))
    # print(head(tmp))
    # glimpse(tmp)
    
    haul <-bind_rows(haul,tmp)
    # if (j==1) t<-tmp else t<-bind_rows(t,tmp)
  }
}

# sort(names(haul))

# rename and manipulate dataset
haul <- 
# t <-
  haul %>% 
  
  mutate_at(c("spawningherring", "herringcaught", "discarded", "typehaul"), list(toupper)) %>% 
  mutate(
    vessel       = gsub("\\s+", "", str_trim(toupper(vessel))),
    haul         = as.integer(haul),
    shoottime    = as.POSIXct( as.numeric(shootdatetime) * (60*60*24), origin="1899-12-30", tz="GMT"),
    haultime     = as.POSIXct( as.numeric(hauldatetime)  * (60*60*24), origin="1899-12-30", tz="GMT"),
    date         = as.Date(as.numeric(date), origin = "1899-12-30"),
    week         = week(date),
    # shootdatetime= as.numeric(shootdatetime),
    # hauldatetime = as.numeric(hauldatetime),
    # shoottime    = as.numeric(shoottime),
    # shoottime    = ifelse(is.na(shoottime) & !is.na(shootdatetime), 
    #                       shootdatetime-floor(shootdatetime), shoottime),
    # haultime     = as.numeric(haultime),
    # haultime     = ifelse(is.na(haultime) & !is.na(hauldatetime), 
    #                       hauldatetime-floor(hauldatetime), haultime),
    surfacetemp  = as.numeric(surfacetemp),
    headlinetemp = as.numeric(headlinetemp),
    headlinedepth= as.numeric(headlinedepth),
    waterdepth   = as.numeric(waterdepth),
    meshsize     = as.numeric(meshsize),
    vertopening  = as.numeric(vertopening),
    horzopening  = as.numeric(horzopening),
    catch        = as.numeric(catch),
    typehaul     = ifelse(is.na(typehaul) & grepl("commercial",tolower(file)), "C",typehaul),
    typehaul     = ifelse(grepl("comm", tolower(typehaul)), "C", typehaul),
    typehaul     = ifelse(grepl("surv", tolower(typehaul)), "S", typehaul),
    typehaul     = toupper(typehaul),
    plotlon      = as.numeric(plotlon),
    plotlat      = as.numeric(plotlat),
    division     = geo_inside(lon=plotlon, lat=plotlat, 
                              map=fao[fao@data$F_LEVEL=="DIVISION",], variable="F_DIVISION"),
    rect         = geo_inside(lon=plotlon, lat=plotlat, 
                              map=icesrectangles, variable="ICESNAME"),
    surveyarea   = 
      ifelse (point.in.polygon(plotlon, plotlat,
                               areas$long[areas$area==1], 
                               areas$lat[areas$area ==1])>0, "1",NA),
    surveyarea   = 
      ifelse (point.in.polygon(plotlon, plotlat,
                               areas$long[areas$area==2], 
                               areas$lat[areas$area ==2])>0, "2", surveyarea),
    surveyarea   = 
      ifelse (point.in.polygon(plotlon, plotlat,
                               areas$long[areas$area==3], 
                               areas$lat[areas$area ==3])>0, "3",surveyarea),          
    surveyarea   = 
      ifelse (point.in.polygon(plotlon, plotlat, 
                               areas$long[areas$area==4], 
                               areas$lat[areas$area ==4])>0, "4",surveyarea),
    surveyarea   = 
      ifelse (point.in.polygon(plotlon, plotlat, 
                               areas$long[areas$area==5], 
                               areas$lat[areas$area ==5])>0, "5",surveyarea),
    
    # Outside of survey areas but within 6a
    surveyarea  = 
      ifelse(is.na(surveyarea) & division == "27.6.a" & shootlat >= 56, "oth", surveyarea), 

    surveyarea  = 
      ifelse(is.na(surveyarea) & division == "27.6.a" & shootlat < 56, "div6.as", surveyarea), 
    
    surveyarea =
      ifelse(division %in% c("27.4.a","27.4.b","27.7.a"), paste0("div",substr(division,4,6)), surveyarea),
    
    surveyarea = 
      ifelse(surveyarea %in% as.character(1:5), paste0("area",surveyarea), surveyarea)
  ) %>%
  
  left_join(vesselnames, by="vessel") %>% 
  mutate(vesselname2  = paste0(vesselname," (", vessel, ")") ) %>% 
  dplyr::select(-distancemile, -distancemileperhour, - distancetopreviousmile,
                -distancetopreviousmileperhour, -hourstoprevious)

# filter(t, vessel == "PD265") %>% View()
# filter(haul, vessel == "PD265") %>% View()
# unique(haul$surveyarea)
# sort(names(haul))

# save RData file
save(haul, file=file.path(dropboxdir, surveyyear, "DATA","rdata", "haul.RData", sep=""))

# haul %>% filter(vessel == "N905") %>% View()

# haul %>% filter(typehaul=="S", division=="27.4.a", surveyarea == "2") %>% View()
# haul %>% filter(surveyarea == "oth") %>% View()
# haul %>% filter(is.na(typehaul)) %>% View()

# ================================================================================
#  Reading bio data
# ================================================================================

# i <- 2

bio <- NULL
j   <- 0

for (i in 1:length(file.list)){   
  
  print(file.list[i])
  
  if ("Bio" %in% excel_sheets(file.list[i])) {
    j <- j+1
    tmp <- 
      read_excel(file.list[i], sheet="Bio", col_names=TRUE, col_types="text", skip=0 ) %>% 
      lowcase() %>% 
      mutate(file   = file.list[i],
             sheet  = "Bio") %>% 
      filter(!is.na(haul)) %>% 
      data.frame()
    
    # print(head(tmp))
    
    bio <-bind_rows(bio,tmp)
    # if (j==1) t<-tmp else t<-bind_rows(t,tmp)
  }
}

# sort(names(bio))

# rename and manipulate dataset
bio <- 
  bio %>% 

  rename(length = lengthcm,
         weight = weightg) %>% 
  
  # 
  mutate(vessel = gsub("\\s+", "", str_trim(toupper(vessel))),
         haul   = as.integer(haul),
         date   = as.Date(as.numeric(date), origin = "1899-12-30"),
         fishid = as.integer(fishid),
         
         # length in half cm groups
         length = as.numeric(length),
         length = floor(length * 2)/2 , 
         
         # length in cm groups
         lengthcm = floor(length), 
         
         weight = as.numeric(ifelse(weight == 0, NA, weight)),
         maturitystage   = as.numeric(maturitystage),

         # express all maturity on 1-6 scale
         mat    = ifelse(maturityscale == "1-6", maturitystage, NA),
         
         mat    = case_when(
           maturityscale == "1-9" & maturitystage %in% 2    ~ 1,
           maturityscale == "1-9" & maturitystage %in% 3:4  ~ 2,
           maturityscale == "1-9" & maturitystage %in% 5:6  ~ 3,
           maturityscale == "1-9" & maturitystage %in% 7    ~ 4,
           maturityscale == "1-9" & maturitystage %in% 8    ~ 5,
           maturityscale == "1-9" & maturitystage %in% 9    ~ 6, 
           TRUE                                             ~ mat),
         age    = as.integer(age),
         wr     = as.integer(wr) ) %>% 
  # select(-haultype, -nearestlowest05, -measuredlengthcm) %>% 
  select(-haultype) %>% 
  left_join(select(haul, 
                   vessel, vesselname, vesselname2, trip, haul, typehaul, division, surveyarea),
            by=c("vessel","trip","haul"))  %>% 
  
  # remove ages in haul 10 from Alida 2018L3 (there was a problem with sampling)
  mutate (birthyear = ifelse(vessel == "SCH6" & trip == "2018L3" & haul == 10, NA, birthyear),
          age       = ifelse(vessel == "SCH6" & trip == "2018L3" & haul == 10, NA, age),
          wr        = ifelse(vessel == "SCH6" & trip == "2018L3" & haul == 10, NA, wr))


# unique(bio$vessel)
# unique(haul$vessel)
# unique(haul$vesselname)
# unique(bio$vesselname)
# unique(haul$trip)
# glimpse(bio)
# unique(bio$length)

# filter(bio, !is.na(mat)) %>% View()
# filter(bio, vessel == "KW172") %>% View()

# bio %>% View()


# save RData file
save(bio, file=file.path(dropboxdir, surveyyear, "DATA","rdata", "bio.RData", sep=""))

# ================================================================================
# read length sheets
# ================================================================================

# i <- 1
length <- NULL
j      <- 0

for (i in 1:length(file.list)){   
  
  print(file.list[i])
  
  if ("L1" %in% excel_sheets(file.list[i])) {
    j <- j+1
    tmp<- 
      read_excel(file.list[i], sheet="L1", col_names=TRUE, col_types ="text", skip=0 ) %>% 
      lowcase() %>% 
      mutate(file   = file.list[i],
             sheet  = "Length") %>% 
      filter(!is.na(haul), !is.na(count), count != 0) %>% 
      data.frame()
    
    # print(head(tmp))
    
    length = bind_rows(length, tmp)
    # if (j==1) t<-tmp else t<-bind_rows(t,tmp)
  }
}

# sort(names(length))

# rename and manipulate dataset
length <- 
  length %>% 
  mutate(length = as.numeric(length),

         # length in cm groups
         lengthcm = floor(length), 
         
         vessel = gsub("\\s+", "", str_trim(toupper(vessel))),
         haul   = as.integer(haul),
         sampleweight = as.numeric(sampleweight),
         date   = as.Date(as.numeric(date), origin = "1899-12-30"),
         count  = as.integer(count) ) %>% 
  filter(merk == "0") %>% 
  left_join(select(haul, vessel, vesselname, vesselname2, trip, haul, typehaul, division, surveyarea),    by=c("vessel","trip","haul"))

# save RData file
save(length, file=file.path(dropboxdir, surveyyear, "DATA","rdata", "length.RData", sep=""))


# ================================================================================
# read species compositions
# ================================================================================

# i <- 1
t      <- NULL
j      <- 0

for (i in 1:length(file.list)){   
  
  print(file.list[i])
  
  if ("S2" %in% excel_sheets(file.list[i])) {
    j <- j+1
    tmp<- 
      read_excel(file.list[i], sheet="S2", col_names=TRUE, col_types ="text", skip=0 ) %>% 
      lowcase() %>% 
      mutate(
        file   = file.list[i],
        sheet  = "S2") %>% 
      mutate(proportion = as.numeric(proportion) ) %>%
      mutate(haul       = as.integer(haul) ) %>%
      filter(!is.na(haul), !is.na(proportion), proportion != 0) %>% 
      data.frame()
    
    # print(head(tmp))
    
    t = bind_rows(t, tmp)
    # if (j==1) t<-tmp else t<-bind_rows(t,tmp)
  }
}

# glimpse(t)
# glimpse(haul)
# head(haul)
# haul %>% filter(vessel == "FR249") %>% distinct(vessel, trip, haul) %>% View()
# t %>% filter(vessel == "FR249") %>% distinct(vessel, trip, haul) %>% View()


# rename and manipulate dataset
sph <- 
  haul %>% 
  ungroup() %>% 
  left_join(dplyr::select(t, -file, -sheet, -x1, -x2), 
            by=c("vessel","trip","haul")) %>% 
  group_by(vessel, trip, haul) %>% 
  mutate(proportion = proportion / sum(proportion, na.rm=TRUE)) %>% 
  mutate(catch      = ifelse(!is.na(proportion), proportion*catch, catch)) %>% 
  dplyr::select(-proportion) 


# save RData file
save(sph, file=file.path(dropboxdir, surveyyear, "DATA","rdata", "sph.RData", sep=""))

# summaries

n6aherringhauls <-
  bio %>% 
  filter(species == "HER" & division == "27.6.a") %>% 
  group_by(vessel, trip, haul) %>% 
  filter(row_number() ==1 ) %>% 
  nrow()

n4herringhauls <-
  bio %>% 
  filter(species == "HER" & division %in% c("27.4.a","27.4.b")) %>% 
  group_by(vessel, trip, haul) %>% 
  filter(row_number() ==1 ) %>% 
  nrow()

n6aherringsampled <-
  bio %>% 
  filter(species == "HER" & division == "27.6.a") %>% 
  group_by(vessel, trip, haul) %>% 
  nrow()

n4herringsampled <-
  bio %>% 
  filter(species == "HER" & division %in% c("27.4.a","27.4.b")) %>% 
  group_by(vessel, trip, haul) %>% 
  nrow()

n6aherringhaulswithspawning <-
  haul %>% 
  filter(division == "27.6.a") %>%
  group_by(vessel, trip, haul, spawningherring) %>% 
  summarize(n=n()) %>% 
  group_by(spawningherring) %>% 
  summarize(n = sum(n, na.rm=TRUE)) %>% 
  ungroup() %>% 
  mutate(sum = sum(n)) %>% 
  filter(spawningherring=="Y") %>% 
  mutate(str = paste(n, " out of ", sum))


xlim <- c(-8,0)
ylim <- c(57,60)



# bio %>% filter(!is.na(age), is.na(wr)) %>% View()
# length %>% filter(is.na(vesselname)) %>% View()
# bio %>% filter(!is.na(age), is.na(wr)) %>% View()
# bio %>% filter(wr > 10) %>% View()

```


## Sampling summary

Martin Pastoors

Date: `r format(Sys.time(), '%d/%m/%Y %X')`

The six vessels covered four different areas between `r min(haul$date, na.rm=TRUE)` and the `r max(haul$date, na.rm=TRUE)` (Figure 3.1), making a total of `r nrow(haul)` hauls, of which `r nrow(filter(haul, typehaul=="S"))` were taken in survey mode and `r nrow(filter(haul, typehaul=="C"))` during commercial fisheries. It should be noted that the Grateful (FR249) participated as part of the ICES HERAS survey and thereby did not directly contribute to the 6a herring spawning survey effort. In addition, a number of commercial hauls (`r nrow(filter(haul, typehaul=="C" & division %in% c("27.4.a", "27.4.b")))`) were taken in in the North Sea (27.4.b) just prior or after the survey. 

Within area 6a, herring were caught and sampled during `r n6aherringhauls` hauls, resulting in biological information collected from a total of `r n6aherringsampled` herring (Table 3.1). 

Spawning herring were found in `r n6aherringhaulswithspawning$str` hauls  (Figure 3.2).

Maps of the survey tracks, relative acoustic density, and locations of hauls whose biological data was used in for the estimation of the biomass of herring in 6aN are shown in Figure 3.5, Table 3.2. _[This needs to come from Benoit. Alternatively, I could make them and include in the sampling overview, if there is a standard data format available]_ 


```{r, echo=FALSE, message=FALSE, warning=FALSE}

# overall summaries (per haul and per fish)

haul %>%
  filter(division == "27.6.a") %>% 
  group_by(vesselname2, surveyarea) %>% 
  summarize(catch=sum(catch,na.rm=TRUE)) %>% 
  dcast(vesselname2 ~ surveyarea, sum, value.var="catch", margins=TRUE) %>% 
  pandoc.table(.,
             style = "simple",
             split.tables=400, 
             justify = "left",
             missing=".",
             round=c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0))


```

_Table 3.1: Total catch in 6a by area (all species). _

```{r, echo=FALSE, message=FALSE, warning=FALSE}

# overall summaries (per species)

sph %>%
  filter(division == "27.6.a") %>% 
  group_by(vesselname2, species) %>% 
  summarize(catch=sum(catch,na.rm=TRUE)) %>%
  filter(catch > 0.5) %>%
  dcast(vesselname2 ~ species, sum, value.var="catch", margins=TRUE) %>% 
  pandoc.table(.,
             style = "simple",
             split.tables=400, 
             justify = "left",
             missing=".",
             round=c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0))


```

_Table 3.2: Total catch in 6a by area (all species). _

```{r, echo=FALSE, message=FALSE, warning=FALSE}

# overall summaries (per haul and per fish)

t1 <-
  bio %>% 
  filter(species=="HER") %>% 
  mutate(spawning = ifelse(mat == "3", "Y","N"),
         haul     = paste(trip,str_pad(haul,2, pad="0"), sep="")) %>% 
  group_by(vessel, trip, haul, typehaul, spawning) %>% 
  summarize(nlength   = sum(!is.na(length)),
            nphoto    = sum(!is.na(imagelabel)),
            ngen      = sum(!is.na(geneticlabel))) %>% 
  group_by(typehaul, spawning) %>% 
  summarize(sampledhauls   = n_distinct(haul),
            morphometrics  = sum(nphoto> 0),
            genetics       = sum(ngen > 0)) %>% 
  mutate(counted = "haul")

t2 <-
  bio %>% 
  filter(species=="HER") %>% 
  mutate(spawning = ifelse(mat == "3", "Y","N")) %>% 
  group_by(vessel, trip, typehaul, spawning) %>% 
  summarize(nfish     = sum(!is.na(length)),
            nphoto    = sum(!is.na(imagelabel)),
            ngen      = sum(!is.na(geneticlabel))) %>% 
  group_by(typehaul, spawning) %>% 
  summarize(sampledhauls     = sum(nfish),
            morphometrics    = sum(nphoto),
            genetics      = sum(ngen)) %>% 
  mutate(counted= "fish")


t3 <-
  bind_rows(t1,t2) %>%
  gather(key=variable, value=number, sampledhauls:genetics) %>% 
  group_by(typehaul, counted, variable) %>% 
  summarize(number=sum(number, na.rm=TRUE)) %>% 
  mutate(spawning="ALL")

t4 <-
  bind_rows(t1,t2) %>%
  gather(key=variable, value=number, sampledhauls:genetics) %>% 
  filter(spawning == "Y") %>% 
  group_by(typehaul, counted, variable) %>% 
  summarize(number=sum(number, na.rm=TRUE)) %>% 
  mutate(spawning="SPAWNING")

bind_rows(t3,t4) %>% 
  dcast(typehaul+variable ~ counted+spawning, sum, value.var="number", 
        margins=c("variable", "haultype")) %>% 
  select(typehaul, variable, haul_ALL, haul_SPAWNING, fish_ALL, fish_SPAWNING) %>% 
  rename(haultype    = typehaul,
         datatype    = variable,
         nhauls     = haul_ALL,
         nfish      = fish_ALL,
         nhaul_withspawners = haul_SPAWNING,
         nspawning_fish      = fish_SPAWNING) %>% 
  
  group_by(haultype) %>%
  do(add_row(., .after=0)) %>%

  pandoc.table(.,
             style = "simple",
             split.tables=400, 
             justify = "left",
             missing=" ",
             round=c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0))

```

_Table 3.3: overview of number of hauls and number of herring collected during commercial fishing operation (C) or survey operations (S) and for which either morphometric or genetic samples have been collected. Either all observations or for spawning herring only. _


```{r, echo=FALSE, message=FALSE, warning=FALSE}

# trip summaries
t1 <-
  haul %>% 
  group_by(vessel, vesselname, vesselname2, trip, typehaul) %>% 
  summarize(datestart = min(date, na.rm=TRUE),
            dateend   = max(date, na.rm=TRUE),
            nhaul     = n())

t2 <-
  length %>% 
  filter(species=="HER") %>% 
  group_by(vessel, vesselname, vesselname2, trip, typehaul) %>% 
  summarize(nlength   = sum(count, na.rm=TRUE))

t3 <-
  bio %>% 
  filter(species == "HER") %>% 
  group_by(vessel, vesselname, vesselname2, trip, typehaul) %>% 
  summarize(nwght   = sum(!is.na(weight)),
            nage      = sum(!is.na(wr)),
            nsex      = sum(!is.na(sex)),
            nmat      = sum(!is.na(mat)),
            nphoto    = sum(!is.na(imagelabel)),
            ngen      = sum(!is.na(geneticlabel)))

t1 %>% 
  left_join(t2, by=c("vessel","vesselname","vesselname2", "trip","typehaul")) %>%
  left_join(t3, by=c("vessel","vesselname","vesselname2", "trip","typehaul")) %>%
  gather(key=variable, value=value, nhaul:ngen) %>% 
  ungroup() %>% 
  dplyr::select(-vessel, -vesselname) %>% 
  rename(haultype    = typehaul,
         vessel = vesselname2, 
         begin = datestart, 
         end=dateend) %>% 
  dcast(haultype+vessel+trip+begin+end ~ variable, value.var="value", sum, margins=c("vessel"), na.rm=TRUE) %>% 
  
  group_by(vessel) %>%
  do(add_row(., .after=0)) %>%
  
  pandoc.table(.,
             style = "simple",
             split.tables=400, 
             justify = "left",
             missing=" ",
             round=c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0))


```

_Table 3.4: overview of trip properties. 'Type' refers to the type of activity (S=survey, C=commercial). The variables starting with 'n' denote the number of fish measured for the specific variable._


```{r, echo=FALSE, message=FALSE, warning=FALSE}

# bio %>% filter(vessel == "KW172" & mat == "3") %>% View()

# trip summaries for spawning herring
bio %>% 
  filter(species =="HER") %>% 
  filter(mat == "3") %>% 
  group_by(vesselname2, trip, typehaul) %>% 
  summarize(nlen   = sum(!is.na(length)),
            nwght   = sum(!is.na(weight)),
            nage      = sum(!is.na(wr)),
            nsex      = sum(!is.na(sex)),
            nphoto    = sum(!is.na(imagelabel)),
            ngen      = sum(!is.na(geneticlabel))) %>% 
  gather(key=variable, value=value, nlen:ngen) %>% 
  rename(name = vesselname2, haultype=typehaul) %>% 
  dcast(haultype+name+trip ~ variable, value.var="value", sum, margins=c("name")) %>% 
  
  group_by(haultype) %>%
  do(add_row(., .after=0)) %>%
  
  pandoc.table(.,
             style = "simple",
             split.tables=400, 
             justify = "left",
             missing=".",
             round=c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0))


```

_Table 3.5: overview of the number of spawning herring and the measurements taken on these fish._


```{r, echo=FALSE, message=FALSE, warning=FALSE}

# trip summaries for spawning herring
bio %>% 
  filter(species =="HER") %>%
  filter(mat <= 4) %>% 
  # filter(!is.na(geneticlabel)) %>%
  mutate(mat = case_when(
    mat %in% 1    ~ "immature",
    mat == 2      ~ "ripening",
    mat == 3      ~ "spawning",
    mat == 4      ~ "spent",
    mat %in% 5:6  ~ "other",
    TRUE          ~ "unknown"
  )) %>% 
  mutate(mat = factor(mat, levels=c("immature", "ripening","spawning", "spent"))) %>% 
  
  group_by(vessel, trip, haul, mat) %>% 
  summarize(n = n(),
            ngen = sum(!is.na(geneticlabel))) %>% 
  mutate(str = paste(n, " (gen=", ngen, ")", sep="")) %>%
  dplyr::select(-n, -ngen) %>% 
  left_join(dplyr::select(haul, vessel, trip, haul, date, plotlat, plotlon, surveyarea),
            by = c("vessel", "trip", "haul")) %>% 
  group_by(vessel, trip, haul, date, plotlon, plotlat, surveyarea) %>% 
  spread(key=mat, value = "str") %>% 
  
  group_by(vessel, trip) %>%
  do(add_row(., .after=0)) %>%
  
  pandoc.table(.,
             style = "simple",
             split.tables=400, 
             justify = "left",
             missing=" ",
             round=c(0,0,0,0,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0))




```

_Table 3.6: Overview of genetic samples_

```{r, echo=FALSE, message=FALSE, warning=FALSE}

# haul summaries
bio %>% 
  filter(species=="HER") %>%   
  group_by(vesselname2, trip, typehaul, haul, surveyarea) %>% 
  summarize(nlen      = sum(!is.na(length)), 
            nwght     = sum(!is.na(weight)),
            nage      = sum(!is.na(wr)),
            nsex      = sum(!is.na(sex)),
            nmat      = sum(!is.na(mat)),
            nphoto    = sum(!is.na(imagelabel)),
            ngen      = sum(!is.na(geneticlabel))) %>% 
  gather(key=variable, value=value, nlen:ngen) %>% 
  rename(vessel = vesselname2, haultype=typehaul, area=surveyarea) %>% 
  dcast(haultype+area+vessel+trip+haul ~ variable, value.var="value", sum, margins=c("area","vessel")) %>% 
  
  group_by(haultype) %>%
  do(add_row(., .after=0)) %>%
  
  pandoc.table(.,
             style = "simple",
             split.tables=400, 
             justify = "left",
             missing=" ",
             row.names=FALSE,
             round=c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0))




```


_Table 3.7: overview of haul properties. 'Type' refers to the type of activity (S=survey, C=commercial). The variables starting with 'n' denote the number of fish measured for the specific variable._


```{r, echo=FALSE, fig.width=10, fig.asp=1.4, fig.align="center", message=FALSE, warning=FALSE}

# plot trips
haul %>%
  
  # filter(typehaul=="S", division=="27.4.a") %>% 
  # filter(date %in% c(as.Date("2018-09-10"): as.Date("2018-09-15"))) %>% 
  mutate(vesseltrip = paste(vesselname2,trip,sep="_")) %>%
  
  ggplot(aes(plotlon, plotlat)) + 
  theme_publication() +
  theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
        panel.border     = element_rect(colour="gray" , size=0.2),
        legend.title=element_blank() ) +
  
  coord_quickmap(xlim=xlim , ylim=ylim) +
  geom_polygon(data=world.europe.df, aes(long, lat, group=group),
               fill = "lightgray", colour=NA) +
  geom_polygon(data=fao27.df,   aes(long, lat, group=group),
               fill = NA, size=0.3, colour="black") +
  geom_polygon(data=areas, aes(long, lat, group=area), colour="red", size=0.2,fill=NA) +
  # geom_jitter(aes(size=catch, colour=factor(typehaul)), alpha = 0.6) +
  geom_point(colour="blue", alpha = 0.6, size=2) +
  # geom_line(aes(colour=factor(paste0(vessel,trip))), alpha = 0.6) +
  
  labs(x = NULL, y = NULL, title=paste0("Haul positions for each of the trips")) +
  guides(size = guide_legend(nrow = 1)) +
  facet_wrap(~vesseltrip, ncol=2)

# haul %>% 
#   filter(is.na(surveyarea), plotlon < -5)
```

_Figure 3.1: Haul positions by vessel (trip)_

```{r, echo=FALSE, fig.width=10, fig.asp=0.5, fig.align="center", message=FALSE, warning=FALSE}

# plot survey and commerical catches
haul %>%
  mutate(spawning = case_when(
    spawningherring == "Y" ~ "spawning",
    spawningherring == "N" ~ "non-spawning",
    TRUE                   ~ "unknown"
  )) %>% 
  mutate(haultype = case_when(
    typehaul == "C" ~ "commercial",
    typehaul == "S" ~ "survey",
    TRUE            ~ "unknown"
  )) %>% 

  ggplot(aes(plotlon, plotlat)) + 
  theme_publication() +
  theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
        panel.border     = element_rect(colour="gray" , size=0.2),
        legend.title=element_blank() ) +
  
  coord_quickmap(xlim=xlim , ylim=ylim) +
  geom_polygon(data=world.europe.df, aes(long, lat, group=group),
               fill = "lightgray", colour=NA) +
  geom_polygon(data=fao27.df,   aes(long, lat, group=group),
               fill = NA, size=0.3, colour="black") +
  geom_polygon(data=areas, aes(long, lat, group=area), colour="red", size=0.2,fill=NA) +
  # geom_jitter(aes(size=catch, colour=factor(typehaul)), alpha = 0.6) +
  geom_jitter(aes(colour=factor(spawning)), alpha = 0.6, size=2) +
  labs(x = NULL, y = NULL, title="Haul positions with spawning and non-spawning herring") +
  guides(size = guide_legend(nrow = 1)) +
  facet_wrap(~haultype)

# haul %>% 
#   filter(is.na(surveyarea), plotlon < -5)
```

_Figure 3.2: spatial distribution of commercial hauls (C) and survey hauls (S) with spawning and non-spawning herring._

```{r, echo=FALSE, fig.width=10, fig.asp=1.4, fig.align="center", message=FALSE, warning=FALSE}

# hauls with spawning herring, morphometric samples and genetic samples

t1 <-
  bio %>% 
  mutate(spawner = ifelse(mat == "3", "Y","N")) %>% 
  group_by(vesselname2, trip, haul, spawner) %>% 
  summarize(spawning      = sum(!is.na(length)),
            morphometrics = sum(!is.na(imagelabel)),
            genetics      = sum(!is.na(geneticlabel))) %>% 
  gather(key=variable, value=number, spawning:genetics) %>% 
  filter(!(variable=="spawning" & spawner != "Y")) %>% 
  group_by(vesselname2, trip, haul, variable) %>% 
  summarize(number=sum(number, na.rm=TRUE)) %>% 
  filter(number > 0) %>% 
  left_join(select(haul, vesselname2, trip, haul, plotlon, plotlat),
            by=c("vesselname2","trip","haul")) %>% 
  mutate(variable=factor(variable, levels=c("spawning","morphometrics","genetics")))


t1 %>%
  ggplot(aes(plotlon, plotlat)) + 
  theme_publication() +
  theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
        panel.border     = element_rect(colour="gray" , size=0.2),
        legend.title     = element_blank(),
        legend.position  = "none") +
  
  coord_quickmap(xlim=xlim , ylim=ylim) +
  geom_polygon(data=world.europe.df, aes(long, lat, group=group),
               fill = "lightgray", colour=NA) +
  geom_polygon(data=fao27.df,   aes(long, lat, group=group),
               fill = NA, size=0.3, colour="black") +
  geom_polygon(data=areas, aes(long, lat, group=area), colour="red", size=0.2,fill=NA) +
  # geom_jitter(aes(size=catch, colour=factor(typehaul)), alpha = 0.6) +
  geom_jitter(aes(colour=factor(variable), size=number), alpha = 0.6) +
  labs(x = NULL, y = NULL, title="Haul positions with spawning herring, morphometrics and genetics") +
  guides(size = guide_legend(nrow = 1)) +
  # facet_wrap(~variable, ncol=2)
  facet_grid(vesselname2~variable)

# haul %>% 
#   filter(is.na(surveyarea), plotlon < -5)
```

_Figure 3.3: spatial distribution of hauls with spawning herring, morphometric samples and genetic samples in the herring survey_


```{r, echo=FALSE, fig.width=10, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE}

# relative herring length distribution by survey area
length %>%
  filter(division == "27.6.a") %>% 
  filter(!is.na(surveyarea)) %>% 
  mutate(length = floor(length)) %>% 

  select(-file, -sheet) %>% 
  left_join(select(haul, vessel, vesselname, trip, haul, typehaul, date, division, surveyarea, catch),
            by=c("vessel","vesselname", "trip","haul","date", "division", "surveyarea")) %>% 
  
  mutate(raisingfactor = catch*1000/sampleweight, 
         countr        = count * raisingfactor,
         week          = week(date)) %>% 
  group_by(species, surveyarea, length) %>% 
  summarize(n = sum(countr, na.rm=TRUE)) %>% 
  group_by(species, surveyarea) %>% 
  mutate(prop = n / sum(n, na.rm=TRUE)) %>% 
  filter(species == "HER") %>% 

  ggplot(aes(x=length, y=prop)) + 
  theme_publication() +
  theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
        panel.border     = element_rect(colour="gray" , size=0.2),
        legend.position = "none") +
  scale_x_reverse() +
  coord_flip() +
  geom_bar(aes(fill=factor(surveyarea)), stat="identity") +
  facet_grid(. ~ surveyarea)

```

_Figure 3.4: Length frequencies of herring catches by survey area_



```{r, echo=FALSE, fig.width=10, fig.asp=1.0, fig.align="center", message=FALSE, warning=FALSE}

# plot of length by haul with geom_ridges (plotted as proportions)
length %>% 
  
  filter(division == "27.6.a") %>% 
  filter(!is.na(surveyarea)) %>% 
  mutate(
    datehaul = paste(date,str_pad(haul, 2, pad = "0"),sep="_"),
    length   = floor(length)) %>% 
  filter(species == "HER") %>% 

  # group_by(vessel, trip, haul, surveyarea, typehaul) %>%
  # filter(row_number() == 1) %>%
  # select(vessel, trip, haul, surveyarea, typehaul) %>%
  # arrange(surveyarea, vessel, trip, haul) %>%
  # write.csv(file="../excel/hauls.csv", row.names=FALSE)

  group_by(datehaul, surveyarea, length) %>% 
  summarize(count = sum(count, na.rm=TRUE)) %>% 
  group_by(datehaul, surveyarea) %>% 
  filter(sum(count, na.rm=TRUE) > 10) %>% 
  mutate(prop  = count / sum(count, na.rm=TRUE)) %>% 
 
  # View()
  
  ggplot(aes(x=length, y=reorder(datehaul, desc(datehaul)), height=prop)) +
  theme_publication() +
  theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
        panel.border     = element_rect(colour="gray" , size=0.2),
        legend.title=element_blank() ) +
  geom_ridgeline(aes(fill=factor(surveyarea)), stat="identity", scale=4, alpha=0.4) +
  labs(y="date_haul") +
  facet_wrap(~surveyarea, ncol=5)


```

_Figure 3.5: Haul by haul relative length frequencies of herring by survey area. Triphaul refers to the combination of vessel, trip and haul_


```{r, echo=FALSE, fig.width=10, fig.asp=1.2, fig.align="center", message=FALSE, warning=FALSE}

# generate length maturity key
mat <- 
  bio %>% 
  filter(!is.na(mat)) %>% 
  filter(division == "27.6.a") %>% 
  filter(species == "HER") %>% 
  
  mutate(length = floor(length)) %>% 
  group_by(species, date, length, mat) %>% 
  summarize(n =n()) %>% 
  group_by(species, date, length) %>% 
  mutate(prop = n / sum(n, na.rm=TRUE))

# plot of maturity transformed back to the length compositions
length %>%
  mutate(length = floor(length)) %>% 
  
  filter(species == "HER") %>% 
  filter(division == "27.6.a") %>% 
  filter(!is.na(surveyarea)) %>% 
  
  left_join(mat, by=c("species","date", "length")) %>% 
  filter(!is.na(mat)) %>% 
  
  mutate(
    triphaul = paste(trip,str_pad(haul, 2, pad = "0"),sep=""),
    count    = count * prop) %>% 
  
  group_by(date, mat) %>%
  summarize(count = sum(count, na.rm=TRUE)) %>% 
  group_by(date) %>% 
  mutate(prop = count / sum(count, na.rm=TRUE)) %>% 
  
  filter(mat <= 4) %>% 
  mutate(mat = paste("mat",mat,sep="")) %>% 

  ggplot(aes(x=date, y=prop, group=mat)) +
  theme_publication() +
  theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
        panel.border     = element_rect(colour="gray" , size=0.2),
        legend.title=element_blank() ) +
  geom_line(colour="black") +
  scale_x_date(breaks=pretty_breaks(), labels = date_format("%d%m")) +
  facet_wrap(~mat)
  # facet_wrap(~mat, ncol=4)

  # plot as geom_joy
  # ggplot(aes(x=mat, y=date, group=date, height=prop)) +
  # theme_publication() +
  # theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
  #       panel.border     = element_rect(colour="gray" , size=0.2),
  #       legend.title=element_blank() ) +
  # geom_joy(stat="identity", scale=1) +
  # facet_wrap(~surveyarea, ncol=4)


```

_Figure 3.6: Maturity stageby day_

```{r eval=FALSE, fig.align="center", fig.asp=0.5, fig.width=10, message=FALSE, warning=FALSE, include=FALSE}

if (sum(!is.na(bio$wr)) > 0) {

  bio %>% 
    filter(!is.na(wr)) %>% 
    filter(!is.na(surveyarea)) %>% 
    filter(division == "27.6.a") %>% 
    
    # filter(vessel=="SCH6") %>% 
    # filter(surveyarea == "area5") %>% 
    # View()
  
    mutate(length = floor(length)) %>% 
    group_by(surveyarea, wr, length) %>%
    summarize(n =n()) %>% 
    group_by(surveyarea, wr) %>% 
    mutate(sum = sum(n), 
           prop = n / sum(n)) %>% 
    
    ggplot(aes(length, wr)) +
    theme_publication() +
    theme(
      strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
      panel.border     = element_rect(colour="gray" , size=0.2), 
      legend.position = "none") +
  
    # geom_boxplot(aes(colour=factor(surveyarea))) + 
    
    geom_ridgeline(aes(group=wr, height=prop, fill=factor(surveyarea)), stat="identity", scale=2, alpha=0.4) +
    geom_point(aes(colour=factor(surveyarea)), alpha=0.5, size=2) +
  
    scale_y_continuous(breaks=pretty_breaks()) +
    facet_wrap( ~ surveyarea, ncol=5) 
  
  }


```

_Figure 3.7: age (wr) - length keys by survey area_

```{r echo=FALSE, fig.align="center", fig.asp=0.5, fig.width=10, message=FALSE, warning=FALSE}

if (sum(!is.na(bio$mat)) > 0) {
  
  bio %>% 
    filter(division == "27.6.a") %>% 
    filter(!is.na(surveyarea)) %>% 
    filter(!is.na(mat)) %>% 
    
    group_by(surveyarea, mat) %>% 
    summarize(count = n()) %>%
    group_by(surveyarea) %>%
    mutate(propmat = count/sum(count)) %>%
    # filter(surveysurveyarea %in% 1:4) %>% 
    
    ggplot(aes(as.factor(mat), propmat)) +
    theme_publication() +
    theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
          panel.border     = element_rect(colour="gray" , size=0.2),
          legend.position = "none") +
    geom_bar(aes(fill=factor(surveyarea)), stat="identity") +
    # scale_x_reverse() +
    # coord_flip() +
    labs(y="frequency", x="maturity") +
    facet_wrap(~ surveyarea, ncol = 5)

  }


```

_Figure 3.8: Maturity (6 scale) by survey area_

```{r, echo=FALSE, fig.width=10, fig.asp=0.5, fig.align="center", message=FALSE, warning=FALSE}

if (sum(!is.na(bio$wr)) > 0) {

  # relative herring wr distribution by survey area
  bio %>%
    filter(division == "27.6.a") %>% 
    filter(!is.na(surveyarea)) %>%
    filter(!is.na(wr)) %>% 
    filter(species == "HER") %>% 
    group_by(species, surveyarea, wr) %>% 
    summarize(n = n()) %>% 
    group_by(species, surveyarea) %>% 
    mutate(prop = n / sum(n, na.rm=TRUE)) %>% 
  
    ggplot(aes(x=wr, y=prop)) + 
    theme_publication() +
    theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
          panel.border     = element_rect(colour="gray" , size=0.2),
          legend.position = "none") +
    geom_bar(aes(fill=surveyarea), stat="identity") +
    scale_x_continuous(breaks = pretty_breaks()) +
    facet_wrap( ~ surveyarea, ncol=5)
  
}



```

_Figure 3.9: Proportion of wr by survey area_


```{r, echo=FALSE, fig.width=10, fig.asp=1.4, fig.align="center", message=FALSE, warning=FALSE}

# comparing herring length distribution by haul from BIO and from LENGTH

l1 <-
  length %>%
  filter(division == "27.6.a") %>% 
  filter(species == "HER") %>% 
  
  mutate(length = floor(length)) %>%
  # mutate(length = floor(2*length)/2) %>% 
  
  group_by(vessel, vesselname2, trip, haul, species, length) %>% 
  summarize(count=sum(count, na.rm=TRUE)) %>% 
  group_by(vessel, vesselname2, trip, haul, species) %>% 
  mutate(prop = count / sum(count, na.rm=TRUE)) %>% 
  mutate(source="length")


l2 <-
  bio %>% 
  filter(division == "27.6.a") %>% 
  filter(species == "HER") %>% 
  
  mutate(length = floor(length)) %>%
  # mutate(length = floor(2*length)/2) %>% 
  
  group_by(vessel, vesselname2, trip, haul, species, length) %>% 
  summarize(count=n()) %>% 
  group_by(vessel, vesselname2, trip, haul, species) %>% 
  mutate(prop = count / sum(count, na.rm=TRUE)) %>% 
  mutate(source="bio")

# bio %>% filter(vessel=="KW172", haul==15) %>% View()

# bio %>% 
  # filter(vessel=="KW172", haul==15) %>%   
  # mutate(length = floor(2*length)/2) %>% 
  # group_by(vessel, vesselname2, trip, haul, species, length) %>% 
  # summarize(count=n()) %>% 
  # View()


# length frequency from self sampling data
l3 <-
  get(load(file.path(onedrive, "rdata", "length_raised.RData"))) %>% 
  filter(vessel == "KW172", trip == "201909") %>% 
  mutate(species = toupper(species)) %>%
  
  mutate(length = floor(length)) %>%
  # mutate(length = floor(2*length)/2) %>% 
  
  filter(species =="HER") %>% 
  filter(haul >= 13) %>% 
  
  group_by(vessel, trip, haul, species, length) %>% 
  summarize(catchnumber = sum(catchnumber, na.rm=TRUE)) %>% 
  group_by(vessel, trip, haul, species) %>% 
  mutate(prop = catchnumber / sum(catchnumber, na.rm=TRUE)) %>% 
  mutate(source="ss")

  
# l2 %>% 
bind_rows(l1, l2, l3) %>%
  filter(trip %in% c("2019094", "201909")) %>% 
  # filter(haul > 13) %>%
  
  group_by(vessel, trip, haul, species) %>%
  filter(n() >3) %>% 
  
  mutate(facet = paste0(vessel, trip, haul)) %>% 
  ggplot(aes(x=length, y=prop)) + 
  theme_publication() +
  theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
        panel.border     = element_rect(colour="gray" , size=0.2)) +
  geom_line(aes(colour=source)) +
  ylim(0,0.5) +
  facet_wrap( ~ facet)

```

_Figure 3.10: Comparing length frequencies from LENGTH and BIO (and SELFSAMPLING)_

```{r printhaulnumberplot, echo=FALSE, message=FALSE, warning=FALSE, fig.asp=1.0}

# myvessel <- unique(haul$vessel)[1]

printhaulnumberplot <- function(myvessel="") {
  
  t <- 
    haul %>% 
    filter(vessel == myvessel) 
  
  if (nrow(t) > 0 ) {
    p <-
      t %>% 
      ggplot(aes(x=plotlon, y=plotlat)) + 
      theme_publication() +
      theme(panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank(),
            text             = element_text(size=12),
            # panel.background = element_rect(fill = "lightskyblue1"),
            plot.margin      = unit(c(0,0,0,0), "cm") ) +  
      
      
      coord_quickmap(xlim=xlim , ylim=ylim) +
      
      # geom_polygon(data=depth200.df,
      #              aes(long, lat, group=group),
      #              size=0.05, colour="lightblue", show.legend = FALSE, fill="lightskyblue") +
      # geom_polygon(data=icesrectangles.df, aes(long, lat, group=group), fill = NA,
      #              size=0.1, color="gray80", alpha=0.3, linetype="solid") +
      
      geom_polygon(data=fao27.df,   aes(long, lat, group=group), fill = NA,
                   size=0.25, color="gray60", alpha=0.3) +
      geom_polygon(data=world.europe.df, aes(x=long, y=lat, group=group), fill = "grey75") +
      
      
      # geom_point(aes(x=haullon, y=haullat), alpha = 0.2, colour = "red", size=0.5) +
    
      geom_point(size=2, alpha = 1, colour = "blue") +
      # geom_text   (aes(x=shootlon, y=shootlat, label=haul),
      #              size=4, color="black", hjust=0.0, vjust=0.0) +
      
      ggrepel::geom_label_repel(aes(x=plotlon, y=plotlat, label=haul),
                   size=4, segment.colour = "gray", hjust=0.0, vjust=0.0) +
      
      # geom_path(aes(x=shootlon,y=shootlat), colour="black", alpha=0.5) +
      labs(x = NULL, y = NULL, title=myvessel) +
      guides(size = guide_legend(nrow = 1))
    
    print(p)
    
  } # end of if statement
} # end of function

for (f in unique(haul$vessel)) {printhaulnumberplot(myvessel = f) }
   

```




























```{r eval=FALSE, fig.align="center", fig.asp=1.2, fig.width=10, message=FALSE, warning=FALSE, include=FALSE}

# plot maturity by rectangle in pie charts
# CANNOT GET THE PIE CHARTS TO BE ROUND !!

mat <- 
  bio %>% 
  filter(!is.na(mat)) %>% 
  filter(mat < 5) %>% 
  select(vessel, trip, haul, species, mat, wr, sex) %>% 
  left_join(haul, by=c("vessel","trip","haul")) %>% 
  group_by(species, week, plotlon, plotlat, surveyarea, mat) %>% 
  summarize(n =n()) %>% 
  group_by(species, week, surveyarea, mat) %>%
  summarize(plotlon = mean(plotlon, na.rm=TRUE),
            plotlat = mean(plotlat, na.rm=TRUE),
            n       = sum(n, na.rm=TRUE)) %>% 
  mutate(mat = paste("mat",mat,"",sep="")) %>% 
  spread(key=mat, value=n, fill=0) %>% 
  mutate(n=(mat1+mat2+mat3+mat4)/200)

mat %>% 
  ggplot(aes(plotlon, plotlat)) + 
  theme_publication() +
  theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
        panel.border     = element_rect(colour="gray" , size=0.2),
        legend.title     = element_blank(),
        legend.position  = "none") +
  
  geom_polygon(data=world.europe.df, aes(long, lat, group=group),
               fill = "lightgray", colour=NA) +
  geom_polygon(data=fao27.df,   aes(long, lat, group=group),
               fill = NA, size=0.3, colour="black") +
  geom_polygon(data=areas, aes(long, lat, group=area), colour="red", size=0.2,fill=NA) +
  geom_scatterpie(data=mat, aes(x=plotlon, y=plotlat, group=week), 
                  cols=c("mat1","mat2","mat3","mat4"), color=NA, alpha=.8) + 
  coord_quickmap(xlim=c(-8,0) , ylim=c(57,60)) +
  facet_wrap(~week)
  # facet_wrap(~mat, ncol=4)

 

```


```{r echo=FALSE, fig.align="center", fig.asp=0.5, fig.width=10, message=FALSE, warning=FALSE}

# if (sum(!is.na(bio$maturitystage19)) > 0) {
# 
#   # generate length maturity key for 9 point scale
#   mat <- 
#     bio %>% 
#     filter(!is.na(mat)) %>% 
#     group_by(species, surveyarea, date, length, maturitystage19) %>% 
#     summarize(n =n()) %>% 
#     group_by(species, surveyarea, date, length) %>% 
#     mutate(prop = n / sum(n, na.rm=TRUE))
#   
#   # plot of maturity transformed back to the length compositions
#   length %>%
#     left_join(mat, by=c("species","surveyarea","date", "length")) %>% 
#     filter(!is.na(surveyarea)) %>% 
#     mutate(triphaul = paste(trip,str_pad(haul, 2, pad = "0"),sep=""),
#            count    = count * prop) %>% 
#     # mutate(date     = as.character(date)) %>% 
#     filter(species == "HER") %>% 
#     filter(!is.na(maturitystage19)) %>% 
#     bind_rows(data.frame(surveyarea="1")) %>% 
#     group_by(date, maturitystage19, surveyarea) %>%
#     summarize(count = sum(count, na.rm=TRUE)) %>% 
#     group_by(date, surveyarea) %>% 
#     mutate(prop = count / sum(count, na.rm=TRUE)) %>% 
#     
#     # proportion of 3s by date
#     
#     # filter(maturitystage19 >= 4, maturitystage19 <= 6, surveyarea == 3) %>% 
#     # ggplot(aes(x=date, y=prop)) +
#     # theme_publication() +
#     # theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
#     #       panel.border     = element_rect(colour="gray" , size=0.2),
#     #       legend.title=element_blank() ) +
#     # geom_line() +
#     # facet_wrap(~maturitystage19, ncol=4)
#   
#     filter(maturitystage19 >= 4, maturitystage19 <= 6, surveyarea == 3) %>%
#     ggplot(aes(x=date)) +
#     theme_publication() +
#     theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
#           panel.border     = element_rect(colour="gray" , size=0.2),
#           legend.title=element_blank() ) +
#     geom_bar(aes(y=prop, fill=maturitystage19), stat="identity", position="fill") 
#   
#     # plot as geom_joy
#     # ggplot(aes(x=mat, y=date, group=date, height=prop)) +
#     # theme_publication() +
#     # theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
#     #       panel.border     = element_rect(colour="gray" , size=0.2),
#     #       legend.title=element_blank() ) +
#     # geom_joy(stat="identity", scale=1) +
#     # facet_wrap(~surveyarea, ncol=4)
# 
#   }



```

