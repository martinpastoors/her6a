---
output:
  word_document: 
    reference_docx: ../my_template.dotx
---


```{r setup, message=FALSE, warning=FALSE, include=FALSE}

require("knitr")
knitr::opts_chunk$set(echo = FALSE,	message = FALSE,	warning = FALSE,	crop = TRUE,	comment = "")
knit_hooks$set(crop = hook_pdfcrop)

```


```{r, message=FALSE, warning=FALSE, include=FALSE}

# ==================================================================
# Combine data templates.r
# 
# Read data and convert to RData sets
#
# Martin Pastoors
#
# 01/11/2016 initial coding
# 06/03/2017 adapted for final report
# 06/04/2017 checking number of samples
# 26/09/2017 reading the 2017 data
# 06/10/2017 finalized reading 2017 data
# 19/10/2017 converted to rMarkdown
# 20/10/2017 started reading lat long files - not continued
# 01/11/2017 finished coding at HER6a workshop
# 07/02/2018 adapted code to latest data spreadsheets
# ==================================================================

# Reset lists
rm(list=ls())

library(sp)            # e.g. point in polygon
library(readxl)        # Hadleys simple package for reading excel
library(lubridate)     # date functions
library(stringr)       # string manipulation
library(pander)        # for tables
library(tidyverse)     # dplyr, tidyr, ggplot etc. 
library(ggjoy)         # ridgelines
library(ggridges)      # new instead of ggjoy 
library(reshape2)      # dcast

# library(gisland)
source("../../gisland/r/geo_inside.R")

# source utils
source("../../mptools/R/my_utils.r")

# get dropbox directory
dropboxdir <- paste(get_dropbox(), "/6a Herring survey planning", sep="")

# ================================================================================
# Set working directory and filename
# ================================================================================

# Working directory
# setwd("D:/Dropbox/6a Herring survey planning/2017/DATA/")
#  load the map files
load(paste(dropboxdir,"/GIS/world.europe.df.RData", sep=""))
load(paste(dropboxdir,"/GIS/eez.europe.df.RData", sep=""))
load(paste(dropboxdir,"/GIS/fao27.df.RData", sep=""))

load(paste(dropboxdir,"/GIS/fao.RData", sep=""))
load(paste(dropboxdir,"/GIS/icesrectangles.RData", sep=""))

# ================================================================================
# Read survey areas
# ================================================================================

areas <- 
  read.csv(file=paste(dropboxdir,"/2017/DATA/Survey areas 2017.csv", sep=""), 
           header=TRUE, stringsAsFactors = FALSE)

# ================================================================================
# Vessel names
# ================================================================================

vesselnames <- data.frame(vessel=c("KW172","PH2200","LK419", "PD265","FR487"),
                          vesselname = c("Dirk Dirk", "Wiron 6", "Antares", "Lunar bow", "Sunbeam"), 
                          stringsAsFactors = FALSE)

# ================================================================================
# Building up file list
# ================================================================================

file.list <- 
  list.files(path = paste(dropboxdir, "/2017/DATA/", sep=""),
             pattern="data template",recursive=F, full.names=TRUE, ignore.case=TRUE)

# ================================================================================
# read haul sheets
# ================================================================================

# i <- 1

j <- 0
for (i in 1:length(file.list)){   
  
  
  if ("Haul" %in% excel_sheets(file.list[i])) {
    j <- j+1
    tmp<- 
      read_excel(file.list[i], sheet="Haul", col_names=TRUE, 
                 col_types ="text", skip=0, range=cell_cols("A:AO") ) %>% 
      lowcase() %>% 
      mutate(file     = file.list[i],
             sheet    = "Haul") %>% 
      filter(!is.na(haul), !is.na(date)) %>% 
      select(one_of(colnames(.)[!grepl("x|X",colnames(.))]) ) %>% 
      data.frame() 

    print(file.list[i])
    # print(names(tmp))
    # print(head(tmp))
    # glimpse(tmp)
    
    if (j==1) t<-tmp else t<-bind_rows(t,tmp)
  }
}

# rename and manipulate dataset
haul <- 
  t %>% 
  
  mutate(
    vessel       = gsub("\\s+", "", str_trim(toupper(vessel))),
    haul         = as.integer(haul),
    date         = as.Date(as.numeric(date), origin = "1899-12-30"),
    week         = week(date),
    shoottime    = as.numeric(shoottime),
    haultime     = as.numeric(haultime),
    surfacetemp  = as.numeric(surfacetemp),
    headlinetemp = as.numeric(headlinetemp),
    headlinedepth= as.numeric(headlinedepth),
    waterdepth   = as.numeric(waterdepth),
    meshsize     = as.numeric(meshsize),
    vertopening  = as.numeric(vertopening),
    horzopening  = as.numeric(horzopening),
    catch        = as.numeric(catch),
    typehaul     = ifelse(is.na(typehaul) & grepl("commercial",tolower(file)), "C",typehaul),
    typehaul     = ifelse(is.na(typehaul), "S", typehaul),
    plotlon      = as.numeric(plotlon),
    plotlat      = as.numeric(plotlat),
    division     = geo_inside(lon=plotlon, lat=plotlat, 
                              map=fao[fao@data$F_LEVEL=="DIVISION",], variable="F_DIVISION"),
    rect         = geo_inside(lon=plotlon, lat=plotlat, 
                              map=icesrectangles, variable="ICESNAME"),
    surveyarea   = 
      ifelse (point.in.polygon(plotlon, plotlat,
                              areas$long[areas$area==1], areas$lat[areas$area==1])>0, "1",NA),
    surveyarea   = 
      ifelse (point.in.polygon(plotlon, plotlat,
                               areas$long[areas$area==2], areas$lat[areas$area==2])>0, "2", surveyarea),
    surveyarea   = 
      ifelse (point.in.polygon(plotlon, plotlat,
                               areas$long[areas$area==3], areas$lat[areas$area==3])>0, "3",surveyarea),          
    surveyarea   = 
      ifelse (point.in.polygon(plotlon, plotlat, 
                               areas$long[areas$area==4], areas$lat[areas$area==4])>0, "4",surveyarea) ) %>% 
  left_join(vesselnames, by="vessel")


# filter(t, vessel == "PD265") %>% View()
# filter(haul, vessel == "PD265") %>% View()

# save RData file
save(haul, file=paste(dropboxdir, "/2017/DATA/rdata/haul.RData", sep=""))

# ================================================================================
#  Reading bio data
# ================================================================================

# i <- 2

j <- 0
for (i in 1:length(file.list)){   
  
  print(file.list[i])
  
  if ("Bio" %in% excel_sheets(file.list[i])) {
    j <- j+1
    tmp <- 
      read_excel(file.list[i], sheet="Bio", col_names=TRUE, col_types="text", skip=0 ) %>% 
      lowcase() %>% 
      mutate(file   = file.list[i],
             sheet  = "Bio") %>% 
      filter(!is.na(haul)) %>% 
      data.frame()
    
    print(head(tmp))
    
    if (j==1) t<-tmp else t<-rbind.all.columns(t,tmp)
  }
}


# rename and manipulate dataset
bio <- 
  t %>% 
  lowcase() %>% 
  rename(length = lengthcm,
         weight = weightg) %>% 
  mutate(vessel = gsub("\\s+", "", str_trim(toupper(vessel))),
         haul   = as.integer(haul),
         date   = as.Date(as.numeric(date), origin = "1899-12-30"),
         fishid = as.integer(fishid),
         length = as.numeric(length),
         length = floor(length * 2)/2 , 
         weight = as.numeric(ifelse(weight == 0, NA, weight)),
         mat    = maturitystage19,
         mat    = ifelse(mat == 0    , NA, mat),
         mat    = ifelse(mat %in% 3:4, 2 , mat),
         mat    = ifelse(mat %in% 5:6, 3 , mat),
         mat    = ifelse(mat == 7    , 4 , mat),
         mat    = ifelse(mat == 8    , 5 , mat),
         mat    = ifelse(mat == 9    , 6 , mat),
         mat    = ifelse(!is.na(maturitystage16), maturitystage16, mat),
         fishid = as.numeric(fishid),
         age    = as.integer(age) ) %>% 
  select(-typehaul) %>% 
  left_join(select(haul, 
                   vessel, vesselname, trip, haul, typehaul, division, surveyarea),
            by=c("vessel","trip","haul"))

# unique(bio$vessel)
# unique(haul$vessel)
# unique(haul$vesselname)
# unique(bio$vesselname)
# unique(haul$trip)
# unique(bio$trip)
# filter(haul, is.na(typehaul)) %>% View()
# bio %>% View()

# save RData file
save(bio, file=paste(dropboxdir, "/2017/DATA/rdata/bio.RData", sep=""))

# ================================================================================
# read length sheets
# ================================================================================

# i <- 1

j <- 0
for (i in 1:length(file.list)){   
  
  print(file.list[i])
  
  if ("L1" %in% excel_sheets(file.list[i])) {
    j <- j+1
    tmp<- 
      read_excel(file.list[i], sheet="L1", col_names=TRUE, col_types ="text", skip=0 ) %>% 
      lowcase() %>% 
      mutate(file   = file.list[i],
             sheet  = "Length") %>% 
      filter(!is.na(haul), !is.na(count), count != 0) %>% 
      data.frame()
    
    print(head(tmp))
    
    if (j==1) t<-tmp else t<-rbind.all.columns(t,tmp)
  }
}

# rename and manipulate dataset
length <- 
  t %>% 
  mutate(length = as.numeric(length),
         vessel = gsub("\\s+", "", str_trim(toupper(vessel))),
         haul   = as.integer(haul),
         sampleweight = as.numeric(sampleweight),
         date   = as.Date(as.numeric(date), origin = "1899-12-30"),
         count  = as.integer(count) ) %>% 
  filter(merk == "0") %>% 
  left_join(select(haul, vessel, vesselname, trip, haul, typehaul, division, surveyarea), by=c("vessel","trip","haul"))

# save RData file
save(length, file=paste(dropboxdir, "/2017/DATA/rdata/length.RData", sep=""))

n6aherringhauls <-
  bio %>% 
  filter(species == "HER" & division == "27.6.a") %>% 
  group_by(vessel, trip, haul) %>% 
  filter(row_number() ==1 ) %>% 
  nrow()

n4herringhauls <-
  bio %>% 
  filter(species == "HER" & division %in% c("27.4.a","27.4.b")) %>% 
  group_by(vessel, trip, haul) %>% 
  filter(row_number() ==1 ) %>% 
  nrow()

n6aherringsampled <-
  bio %>% 
  filter(species == "HER" & division == "27.6.a") %>% 
  group_by(vessel, trip, haul) %>% 
  nrow()

n4herringsampled <-
  bio %>% 
  filter(species == "HER" & division %in% c("27.4.a","27.4.b")) %>% 
  group_by(vessel, trip, haul) %>% 
  nrow()
```


## Sampling summary

Martin Pastoors

Date: `r format(Sys.time(), '%d/%m/%Y %X')`

The six vessels covered four different areas between `r min(haul$date, na.rm=TRUE)` and the `r max(haul$date, na.rm=TRUE)` (Figure 3.1), making a total of `r nrow(haul)` hauls, of which `r nrow(filter(haul, typehaul=="S"))` were taken in survey mode and `r nrow(filter(haul, typehaul=="C"))` during commercial fisheries. It should be noted that a substantial number of commercial hauls were taken in area 4 just prior or after the survey (`r nrow(filter(haul, typehaul=="C" & division %in% c("27.4.a", "27.4.b")))` hauls)

Within area 6a, herring were caught and sampled during `r n6aherringhauls` hauls, resulting in biological information collected from a total of `r n6aherringsampled` herring (Table 3.1). In addition `r n4herringhauls` hauls of herring in the adjacent North Sea are were sampled and biological information was collected from `r n4herringsampled` individual herring. Details on the sampling per trip are shown in Table 3.2 and for spawning herring in Table 3.3. Details on the number of measurement per trip and haul are shown in Table 3.4.

Most of the spawning herring were found in area 3, west of the mainland. Almost no herring were observed in Area 1 (pre-spawning mixing area). No spawning herring were found in the Outer Hebrides (Figure 3.2).

Length distributions of herring were largely similar by survey area and by haul (Figure 3.3, 3.4).

Because many of the samples have been taken in survey area 3, it is possible to focus on the time development in maturity of herring in that area. All maturity data were converted into a common six point scale, in which stage 1 is immature, stage 2 is ripening, stage 3 is spawning and stage 4 is spent or resting. Spawning started on September 1st and that there was still a large amount of spawning activity by the end of the survey on September 12th (Figure 3.5). 

[This needs to come from Benoit]

Maps of the survey tracks, relative acoustic density, and locations of hauls whose biological data was used in for the estimation of the biomass of herring in 6aN are shown in Figure 3.5, Table 3.2.

_Table 3.1: overview of number of hauls and number of herring collected during commercial fishing operation (C) or survey operations (S) and for which either morphometric or genetic samples have been collected. Either all observations or for spawning herring only. _

```{r, echo=FALSE, message=FALSE, warning=FALSE}

# overall summaries (per haul and per fish)

t1 <-
  bio %>% 
  filter(species=="HER") %>% 
  mutate(spawning = ifelse(mat == "3", "Y","N"),
         haul     = paste(trip,str_pad(haul,2, pad="0"), sep="")) %>% 
  group_by(vessel, trip, haul, typehaul, spawning) %>% 
  summarize(nlength   = sum(!is.na(length)),
            nphoto    = sum(!is.na(imagelabel)),
            ngen      = sum(!is.na(geneticlabel))) %>% 
  group_by(typehaul, spawning) %>% 
  summarize(sampledhauls   = n_distinct(haul),
            morphometrics  = sum(nphoto> 0),
            genetics       = sum(ngen > 0)) %>% 
  mutate(counted = "haul")

t2 <-
  bio %>% 
  filter(species=="HER") %>% 
  mutate(spawning = ifelse(mat == "3", "Y","N")) %>% 
  group_by(vessel, trip, typehaul, spawning) %>% 
  summarize(nfish     = sum(!is.na(length)),
            nphoto    = sum(!is.na(imagelabel)),
            ngen      = sum(!is.na(geneticlabel))) %>% 
  group_by(typehaul, spawning) %>% 
  summarize(sampledhauls     = sum(nfish),
            morphometrics    = sum(nphoto),
            genetics      = sum(ngen)) %>% 
  mutate(counted= "fish")


t3 <-
  rbind(t1,t2) %>%
  gather(key=variable, value=number, sampledhauls:genetics) %>% 
  group_by(typehaul, counted, variable) %>% 
  summarize(number=sum(number, na.rm=TRUE)) %>% 
  mutate(spawning="ALL")

t4 <-
  rbind(t1,t2) %>%
  gather(key=variable, value=number, sampledhauls:genetics) %>% 
  filter(spawning == "Y") %>% 
  group_by(typehaul, counted, variable) %>% 
  summarize(number=sum(number, na.rm=TRUE)) %>% 
  mutate(spawning="SPAWNING")

rbind(t3,t4) %>% 
  dcast(typehaul+variable ~ spawning+counted, sum, value.var="number") %>% 
  select(typehaul, variable, ALL_haul, ALL_fish, SPAWNING_haul, SPAWNING_fish) %>% 
  rename(haultype    = typehaul,
         datatype    = variable,
         n_hauls     = ALL_haul,
         n_fish      = ALL_fish,
         n_haul_with_spawners = SPAWNING_haul,
         n_spawning_fish      = SPAWNING_fish) %>% 
  pandoc.table(.,
             style = "simple",
             split.tables=400, 
             justify = "left",
             missing=".",
             round=c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0))

```


_Table 3.2: overview of trip properties. 'Type' refers to the type of activity (S=survey, C=commercial). The variables starting with 'n' denote the number of fish measured for the specific variable._

```{r, echo=FALSE, message=FALSE, warning=FALSE}

# trip summaries
t1 <-
  haul %>% 
  group_by(vessel, vesselname, trip, typehaul) %>% 
  summarize(datestart = min(date, na.rm=TRUE),
            dateend   = max(date, na.rm=TRUE),
            nhaul     = n())

t2 <-
  length %>% 
  filter(species=="HER") %>% 
  group_by(vessel, vesselname, trip, typehaul) %>% 
  summarize(nlength   = sum(count, na.rm=TRUE))

t3 <-
  bio %>% 
  filter(species == "HER") %>% 
  group_by(vessel, vesselname, trip, typehaul) %>% 
  summarize(nweight   = sum(!is.na(weight)),
            nage      = sum(!is.na(age)),
            nsex      = sum(!is.na(sex)),
            nmaturity = sum(!is.na(mat)),
            nphoto    = sum(!is.na(imagelabel)),
            ngenetics = sum(!is.na(geneticlabel)))

t1 %>% 
  left_join(t2, by=c("vessel","vesselname","trip","typehaul")) %>%
  left_join(t3, by=c("vessel","vesselname","trip","typehaul")) %>%
  rename(name = vesselname, begin = datestart, end=dateend, 
         type=typehaul, ngen=ngenetics, nwght = nweight, nlen=nlength, nmat=nmaturity) %>% 
  pandoc.table(.,
             style = "simple",
             split.tables=400, 
             justify = "left",
             missing=".",
             round=c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0))


```


_Table 3.3: overview of the number of spawning herring and the measurements taken on these fish._

```{r, echo=FALSE, message=FALSE, warning=FALSE}

# trip summaries for spawning herring
t3 <-
  bio %>% 
  filter(species =="HER") %>% 
  filter(mat == "3") %>% 
  group_by(vessel, vesselname, trip, typehaul) %>% 
  summarize(nlength   = sum(!is.na(length)),
            nweight   = sum(!is.na(weight)),
            nage      = sum(!is.na(age)),
            nsex      = sum(!is.na(sex)),
            nphoto    = sum(!is.na(imagelabel)),
            ngenetics = sum(!is.na(geneticlabel)))

t3 %>% 
  rename(name = vesselname, 
         type=typehaul, ngen=ngenetics, nwght = nweight, nlen=nlength) %>% 
  pandoc.table(.,
             style = "simple",
             split.tables=400, 
             justify = "left",
             missing=".",
             round=c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0))


```



_Table 3.4: overview of haul properties. 'Type' refers to the type of activity (S=survey, C=commercial). The variables starting with 'n' denote the number of fish measured for the specific variable._

```{r, echo=FALSE, message=FALSE, warning=FALSE}

# haul summaries
t1 <-
  length %>% 
  filter(species=="HER") %>% 
  group_by(vessel, vesselname, trip, typehaul, haul, surveyarea) %>% 
  summarize(nlen   = sum(count, na.rm=TRUE))

# t1 %>% filter(vessel =="KW172") %>% View()

t2 <-
  bio %>% 
  filter(species=="HER") %>%   
  group_by(vessel, vesselname, trip, typehaul, haul, surveyarea) %>% 
  summarize(nwght     = sum(!is.na(weight)),
            nage      = sum(!is.na(age)),
            nsex      = sum(!is.na(sex)),
            nmat      = sum(!is.na(mat)),
            nphoto    = sum(!is.na(imagelabel)),
            ngen      = sum(!is.na(geneticlabel))) 

t1 %>% 
  left_join(t2, by=c("vessel","vesselname","trip", "typehaul","haul","surveyarea")) %>% 
    rename(name = vesselname, area=surveyarea, type=typehaul) %>% 
    pandoc.table(.,
             style = "simple",
             split.tables=400, 
             justify = "left",
             missing=".",
             row.names=FALSE,
             round=c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0))




```




```{r, echo=FALSE, fig.width=10, fig.asp=0.5, fig.align="center", message=FALSE, warning=FALSE}

# plot trips
haul %>%
  ggplot(aes(plotlon, plotlat)) + 
  theme_publication() +
  theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
        panel.border     = element_rect(colour="gray" , size=0.2),
        legend.title=element_blank() ) +
  
  coord_quickmap(xlim=c(-8,0) , ylim=c(57,60)) +
  geom_polygon(data=world.europe.df, aes(long, lat, group=group),
               fill = "lightgray", colour=NA) +
  geom_polygon(data=fao27.df,   aes(long, lat, group=group),
               fill = NA, size=0.3, colour="black") +
  geom_polygon(data=areas, aes(long, lat, group=area), colour="red", size=0.2,fill=NA) +
  # geom_jitter(aes(size=catch, colour=factor(typehaul)), alpha = 0.6) +
  geom_point(aes(colour=factor(paste0(vessel,trip))), alpha = 0.6, size=2) +
  geom_line(aes(colour=factor(paste0(vessel,trip))), alpha = 0.6) +
  
  labs(x = NULL, y = NULL, title="2017 haul positions for each of the trips") +
  guides(size = guide_legend(nrow = 1)) +
  facet_wrap(~vessel)

# haul %>% 
#   filter(is.na(surveyarea), plotlon < -5)
```

```{r, echo=FALSE, fig.width=10, fig.asp=0.5, fig.align="center", message=FALSE, warning=FALSE}

# plot survey and commerical catches
haul %>%
  ggplot(aes(plotlon, plotlat)) + 
  theme_publication() +
  theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
        panel.border     = element_rect(colour="gray" , size=0.2),
        legend.title=element_blank() ) +
  
  coord_quickmap(xlim=c(-8,0) , ylim=c(57,60)) +
  geom_polygon(data=world.europe.df, aes(long, lat, group=group),
               fill = "lightgray", colour=NA) +
  geom_polygon(data=fao27.df,   aes(long, lat, group=group),
               fill = NA, size=0.3, colour="black") +
  geom_polygon(data=areas, aes(long, lat, group=area), colour="red", size=0.2,fill=NA) +
  # geom_jitter(aes(size=catch, colour=factor(typehaul)), alpha = 0.6) +
  geom_jitter(aes(colour=factor(typehaul)), alpha = 0.6, size=2) +
  labs(x = NULL, y = NULL, title="2017 haul positions of commercial (C) and survey (S) hauls") +
  guides(size = guide_legend(nrow = 1)) +
  facet_wrap(~typehaul)

# haul %>% 
#   filter(is.na(surveyarea), plotlon < -5)
```

_Figure 3.1: spatial distribution of commercial hauls (C) and survey hauls (S) in the 2017 herring survey_

```{r, echo=FALSE, fig.width=10, fig.asp=0.9, fig.align="center", message=FALSE, warning=FALSE}

# hauls with spawning herring, morphometric samples and genetic samples

t1 <-
  bio %>% 
  mutate(spawner = ifelse(mat == "3", "Y","N")) %>% 
  group_by(vessel, trip, haul, spawner) %>% 
  summarize(spawning      = sum(!is.na(length)),
            morphometrics = sum(!is.na(imagelabel)),
            genetics      = sum(!is.na(geneticlabel))) %>% 
  gather(key=variable, value=number, spawning:genetics) %>% 
  filter(!(variable=="spawning" & spawner != "Y")) %>% 
  group_by(vessel, trip, haul, variable) %>% 
  summarize(number=sum(number, na.rm=TRUE)) %>% 
  filter(number > 0) %>% 
  left_join(select(haul, vessel, trip, haul, plotlon, plotlat),
            by=c("vessel","trip","haul")) %>% 
  mutate(variable=factor(variable, levels=c("spawning","morphometrics","genetics")))

t1 %>%
  ggplot(aes(plotlon, plotlat)) + 
  theme_publication() +
  theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
        panel.border     = element_rect(colour="gray" , size=0.2),
        legend.title     = element_blank(),
        legend.position  = "none") +
  
  coord_quickmap(xlim=c(-8,0) , ylim=c(57,60)) +
  geom_polygon(data=world.europe.df, aes(long, lat, group=group),
               fill = "lightgray", colour=NA) +
  geom_polygon(data=fao27.df,   aes(long, lat, group=group),
               fill = NA, size=0.3, colour="black") +
  geom_polygon(data=areas, aes(long, lat, group=area), colour="red", size=0.2,fill=NA) +
  # geom_jitter(aes(size=catch, colour=factor(typehaul)), alpha = 0.6) +
  geom_jitter(aes(colour=factor(variable), size=number), alpha = 0.6) +
  labs(x = NULL, y = NULL, title="2017 haul positions with spawning herring, morphometrics and genetics") +
  guides(size = guide_legend(nrow = 1)) +
  # facet_wrap(~variable, ncol=2)
  facet_grid(vessel~variable)

# haul %>% 
#   filter(is.na(surveyarea), plotlon < -5)
```

_Figure 3.2: spatial distribution of hauls with spawning herring, morphometric samples and genetic samples in the 2017 herring survey_


```{r, echo=FALSE, fig.width=10, fig.asp=0.6, fig.align="center", message=FALSE, warning=FALSE}

# relative herring length distribution by survey area
length %>%
  filter(!is.na(surveyarea)) %>% 
  mutate(length = floor(length)) %>% 
  
  select(-file, -sheet) %>% 
  left_join(select(haul, vessel, vesselname, trip, haul, typehaul, date, division, surveyarea, catch),
            by=c("vessel","vesselname", "trip","haul","date", "division", "surveyarea")) %>% 
  mutate(raisingfactor = catch*1000/sampleweight, 
         countr        = count * raisingfactor,
         week          = week(date)) %>% 
  group_by(species, surveyarea, length) %>% 
  summarize(n = sum(countr, na.rm=TRUE)) %>% 
  group_by(species, surveyarea) %>% 
  mutate(prop = n / sum(n, na.rm=TRUE)) %>% 
  filter(species == "HER") %>% 
  bind_rows(data.frame(surveyarea="1")) %>% 
  
  ggplot(aes(x=length, y=prop)) + 
  theme_publication() +
  scale_x_reverse() +
  coord_flip() +
  geom_bar(stat="identity") +
  facet_grid(. ~ surveyarea)

```

_Figure 3.3: Length frequencies of herring catches by survey area_



```{r, echo=FALSE, fig.width=10, fig.asp=1.0, fig.align="center", message=FALSE, warning=FALSE}

# plot of length by haul with geom_ridges (plotted as proportions)
length %>% 
  filter(surveyarea %in% c("1","2","3","4")) %>% 
  mutate(datehaul = paste(date,str_pad(haul, 2, pad = "0"),sep="_")) %>% 
  filter(species == "HER") %>% 
  filter( (vessel == "PH2200" & surveyarea == "2") | 
          (vessel == "PH2200" & surveyarea == "3" & typehaul == "C") |
          (vessel == "KW172") |
          (surveyarea == "3" & typehaul == "C") |
          (surveyarea == "4")) %>% 
  
  # group_by(vessel, trip, haul, surveyarea, typehaul) %>%
  # filter(row_number() == 1) %>%
  # select(vessel, trip, haul, surveyarea, typehaul) %>%
  # arrange(surveyarea, vessel, trip, haul) %>%
  # write.csv(file="../excel/hauls.csv", row.names=FALSE)

  group_by(datehaul, surveyarea, length) %>% 
  summarize(count = sum(count, na.rm=TRUE)) %>% 
  group_by(datehaul, surveyarea) %>% 
  filter(sum(count, na.rm=TRUE) > 10) %>% 
  mutate(prop  = count / sum(count, na.rm=TRUE)) %>% 
 
  # View()
  
  ggplot(aes(x=length, y=reorder(datehaul, desc(datehaul)), height=prop)) +
  theme_publication() +
  theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
        panel.border     = element_rect(colour="gray" , size=0.2),
        legend.title=element_blank() ) +
  geom_ridgeline(stat="identity", scale=6, alpha=0.4) +
  labs(y="date_haul") +
  facet_wrap(~surveyarea, ncol=4)


```

_Figure 3.4: Haul by haul relative length frequencies of herring by survey area. Triphaul refers to the combination of vessel, trip and haul_


```{r, echo=FALSE, fig.width=10, fig.asp=0.5, fig.align="center", message=FALSE, warning=FALSE}

# generate length maturity key
mat <- 
  bio %>% 
  filter(!is.na(mat)) %>% 
  group_by(species, surveyarea, date, length, mat) %>% 
  summarize(n =n()) %>% 
  group_by(species, surveyarea, date, length) %>% 
  mutate(prop = n / sum(n, na.rm=TRUE))

# plot of maturity transformed back to the length compositions
length %>%
  left_join(mat, by=c("species","surveyarea","date", "length")) %>% 
  filter(surveyarea %in% c("1","2","3","4")) %>% 
  mutate(triphaul = paste(trip,str_pad(haul, 2, pad = "0"),sep=""),
         count    = count * prop) %>% 
  # mutate(date     = as.character(date)) %>% 
  filter(species == "HER") %>% 
  filter(!is.na(mat)) %>% 
  bind_rows(data.frame(surveyarea="1")) %>% 
  group_by(date, mat, surveyarea) %>%
  summarize(count = sum(count, na.rm=TRUE)) %>% 
  group_by(date, surveyarea) %>% 
  mutate(prop = count / sum(count, na.rm=TRUE)) %>% 
  
  # proportion of 3s by date
  filter(mat <= 4, surveyarea == 3) %>% 
  
  # View()
  
  ggplot(aes(x=date, y=prop, group=mat)) +
  theme_publication() +
  theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
        panel.border     = element_rect(colour="gray" , size=0.2),
        legend.title=element_blank() ) +
  geom_line(colour="black") +
  facet_wrap(~mat, ncol=4)

  # plot as geom_joy
  # ggplot(aes(x=mat, y=date, group=date, height=prop)) +
  # theme_publication() +
  # theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
  #       panel.border     = element_rect(colour="gray" , size=0.2),
  #       legend.title=element_blank() ) +
  # geom_joy(stat="identity", scale=1) +
  # facet_wrap(~surveyarea, ncol=4)


```

```{r, echo=FALSE, fig.align="center", fig.asp=0.5, fig.width=10, message=FALSE, warning=FALSE}

# generate length maturity key for 9 point scale
mat <- 
  bio %>% 
  filter(!is.na(mat)) %>% 
  group_by(species, surveyarea, date, length, maturitystage19) %>% 
  summarize(n =n()) %>% 
  group_by(species, surveyarea, date, length) %>% 
  mutate(prop = n / sum(n, na.rm=TRUE))

# plot of maturity transformed back to the length compositions
length %>%
  left_join(mat, by=c("species","surveyarea","date", "length")) %>% 
  filter(surveyarea %in% c("1","2","3","4")) %>% 
  mutate(triphaul = paste(trip,str_pad(haul, 2, pad = "0"),sep=""),
         count    = count * prop) %>% 
  # mutate(date     = as.character(date)) %>% 
  filter(species == "HER") %>% 
  filter(!is.na(maturitystage19)) %>% 
  bind_rows(data.frame(surveyarea="1")) %>% 
  group_by(date, maturitystage19, surveyarea) %>%
  summarize(count = sum(count, na.rm=TRUE)) %>% 
  group_by(date, surveyarea) %>% 
  mutate(prop = count / sum(count, na.rm=TRUE)) %>% 
  
  # proportion of 3s by date
  
  # filter(maturitystage19 >= 4, maturitystage19 <= 6, surveyarea == 3) %>% 
  # ggplot(aes(x=date, y=prop)) +
  # theme_publication() +
  # theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
  #       panel.border     = element_rect(colour="gray" , size=0.2),
  #       legend.title=element_blank() ) +
  # geom_line() +
  # facet_wrap(~maturitystage19, ncol=4)

  filter(maturitystage19 >= 4, maturitystage19 <= 6, surveyarea == 3) %>%
  ggplot(aes(x=date)) +
  theme_publication() +
  theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
        panel.border     = element_rect(colour="gray" , size=0.2),
        legend.title=element_blank() ) +
  geom_bar(aes(y=prop, fill=maturitystage19), stat="identity", position="fill") 

  # plot as geom_joy
  # ggplot(aes(x=mat, y=date, group=date, height=prop)) +
  # theme_publication() +
  # theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
  #       panel.border     = element_rect(colour="gray" , size=0.2),
  #       legend.title=element_blank() ) +
  # geom_joy(stat="identity", scale=1) +
  # facet_wrap(~surveyarea, ncol=4)


```

_Figure 3.5: Proportion of maturity stage by date in survey area 3_


```{r, echo=FALSE, fig.align="center", fig.asp=0.5, fig.width=10, message=FALSE, warning=FALSE}

bio %>% 
  filter(!is.na(age)) %>% 
  filter(surveyarea %in% c("1", "2","3","4")) %>% 

  ggplot(aes(length, age)) +
  theme_publication() +
  theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
        panel.border     = element_rect(colour="gray" , size=0.2)) +
  geom_point(aes(colour=factor(surveyarea)), alpha=0.5, size=2) +
  labs(colour="survey area") +
  facet_wrap( ~ surveyarea, ncol=4)

```

_Figure 3.6: Age-lenth keys_



```{r, echo=FALSE, fig.align="center", fig.asp=0.5, fig.width=10, message=FALSE, warning=FALSE}
bio %>% 
  filter(surveyarea %in% c("1","2","3","4")) %>% 
  filter(!is.na(mat)) %>% 
  
  group_by(surveyarea, mat) %>% 
  summarize(count = n()) %>%
  group_by(surveyarea) %>%
  mutate(propmat = count/sum(count)) %>%
  # filter(surveysurveyarea %in% 1:4) %>% 
  
  ggplot(aes(as.factor(mat), propmat)) +
  theme_publication() +
  theme(strip.background = element_rect(colour=NA, fill = "#f0f0f0"),
        panel.border     = element_rect(colour="gray" , size=0.2)) +
  geom_bar(stat="identity") +
  # scale_x_reverse() +
  # coord_flip() +
  labs(y="frequency", x="maturity") +
  facet_wrap(~ surveyarea, ncol = 4)

```

_Figure 3.7: Maturity (6 scale) by area_


```{r, echo=FALSE, fig.width=10, fig.asp=0.8, fig.align="center", message=FALSE, warning=FALSE}

# relative herring length distribution by survey area
bio %>%
  filter(!is.na(surveyarea)) %>% 
  filter(species == "HER") %>% 
  group_by(species, surveyarea, age) %>% 
  summarize(n = n()) %>% 
  group_by(species, surveyarea) %>% 
  mutate(prop = n / sum(n, na.rm=TRUE)) %>% 

  ggplot(aes(x=age, y=prop)) + 
  theme_publication() +
  # scale_x_reverse() +
  # coord_flip() +
  geom_bar(stat="identity") +
  facet_wrap( ~ surveyarea)

```

_Figure 3.8: Proportion of maturity stage by date in survey area 3_
